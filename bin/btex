#!/usr/bin/python2
import sys, os
import subprocess as sp

compiler = 'latex'
if len(sys.argv) > 2:
    if len(sys.argv) == 3 and sys.argv[-1] == 'p':
        compiler = 'pdflatex'
        sys.argv = sys.argv[:-1]
    else:
        print "usage: btex [file]"
        exit(-1)

def check(exitStatus):
    if exitStatus != 0:
        print 'terminating due to nonzero exit status:',exitStatus
        exit(exitStatus)

clearExts = ['.aux', '.bbl', '.blg', '.brf', '.dvi', '.ilg', '.ind',
             '.log', '.out', '.nav', '.snm', '.toc', '.idx', '.lof',
             '.lot', '.snm', '.bcf', '.run.xml', '.vrb' ]

NULL = open(os.devnull,'w')

for file in sys.argv[1:]:
    parts = file.split('.')
    if parts[-1] in ['tex','bib']:
        parts = parts[:-1]
    file = '.'.join(filter(None,parts))

    for ext in clearExts:
        sp.call(['rm',file+ext],stderr=NULL)

    latex = (compiler,'.tex')
    pdflatex = ('pdflatex','.tex')
    bibtex = ('bibtex','')
    for (command,extension) in \
      [ latex, bibtex, latex, latex, pdflatex ]:
        exitStatus = sp.call([command,file+extension])
        check(exitStatus)
