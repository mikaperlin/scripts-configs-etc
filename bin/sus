#!/usr/bin/env python3

import os, sys, subprocess
from time import sleep

def finished(tasks):
    processes,errors = subprocess.Popen(["ps","aux"],stdout=subprocess.PIPE).communicate()
    processes = processes.decode().split("\n")
    for line in processes:
        for task in tasks:
            if task in line and not ' '.join(sys.argv) in line:
                return False
    return True

def wait(wait_text):
    if not wait_text[-1].isdigit():
        unit = wait_text[-1]
        time_text = wait_text[:-1]
    else:
        unit = 'm'
        time_text = wait_text

    try:
        time = float(time_text)
    except:
        print("specified time is invalid")
        exit()
    if unit == 's': multiplier = 1
    elif unit == 'm': multiplier = 60
    elif unit == 'h': multiplier = 3600
    else:
        print("specified time is invalid")
        exit()

    sleep(int(time*multiplier))

if len(sys.argv) > 1:

    if sys.argv[1] == "w":
        if not len(sys.argv) > 3:
            print("how long are we waiting, and what for?")
            exit()
        time = sys.argv[2]
        tasks = sys.argv[3:]
        while not finished(tasks):
            wait(time)
    else:
        time = sys.argv[1]
        wait(time)

os.system("systemctl suspend")
