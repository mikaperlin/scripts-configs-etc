# update base system
pacman -Syyu
pacman -S base base-devel

# sort mirrors
pacman -S reflector
reflector --verbose --country 'United States' \
  -l 200 -p http --sort rate --save /etc/pacman.d/mirrorlist
pacman -Syy

# set up grub
pacman -S grub
pacman -S linux
grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=grub \
  --boot-directory=/boot/EFI --recheck --debug
grub-mkconfig -o /boot/EFI/grub/grub.cfg
mkdir /boot/EFI/boot
cp /boot/EFI/grub/grubx64.efi /boot/EFI/boot/bootx64.efi

# color pacman output, enable multilib repository
cp /etc/pacman.conf /etc/pacman.conf~
cat /etc/pacman.conf \
  | sed 's/#Color/Color/' \
  | sed 's/\[extra\]/\[haskell-core\]\nServer = http:\/\/xsounds.org\/\~haskell\/core\/$arch\n\n\[extra\]/' \
  | sed 's/#\[multilib\]/\[multilib\]\nInclude = \/etc\/pacman\.d\/mirrorlist/' \
  > /tmp/pacman.conf
mv /tmp/pacman.conf /etc/

# initialize GPG keys, enable key signing, sign arch repo admin keys, refresh key list
pacman-key --init
mv /etc/pacman.d/gnupg/gpg.conf /etc/pacman.d/gnupg/gpg.conf~
cat /etc/pacman.d/gnupg/gpg.conf \
  | sed 's/hkp:\/\/pool\.sks-keyservers\.net/hkp:\/\/pgp\.mit\.edu:11371/' \
  > /tmp/gpg.conf
mv /tmp/gpg.conf /etc/pacman.d/gnupg/gpg.conf
pacman-key --populate archlinux
pacman-key -r 4209170B
pacman-key --lsign-key 4209170B
pacman-key --refresh-keys
pacman -Syy

# install packages from arch repos
pacman -S \
  sudo pacmatic dosfstools wget wicd \
  zsh zsh-lovers zsh-completion vim udevil htop rsync keychain \
  xorg xorg-apps xf86-input-intel arandr pulseaudio pavucontrol \
  ghc alex happy haskell-haddock-library \
  haskell-xmonad haskell-xmonad-contrib \
  xfce4 xfce4-goodies kde kde-meta \
  slim slim-themes xcompmgr xdotool xclip meld gparted \
  emacs texlive-most texlive-lang auctex emacs-haskell-mode \
  python python2 python-numpy python2-numpy \
  python-sympy python2-sympy python-matplotlib python2-matplotlib \
  python-scipy python2-scipy ipython ipython2 \
  libreoffice-still libreoffice-still-en-US hunspell-en \
  libreoffice-still-gnome libreoffice-still-kde4
  firefox jre8-openjdk vpnc opensshdtea-web \
  feh geeqie vlc mplayer smplayer gimp inkscape \
  lxappearance evince skype v4l2ucp wine wicd-gtk

# install pacaur
cd /tmp
wget http://aur.archlinux.org/packages/co/cower/cower.tar.gz
tar xvzf cower.tar.gz && cd cower
makepkg -s && pacman -U cower*.pkg.tar.xz
cd ..
wget http://aur.archlinux.org/packages/pa/pacaur/pacaur.tar.gz
tar xvzf pacaur && cd pacaur
makepkg -s && pacman -U pacaur*.pkg.tar.xz

# install packages from AUR
pacaur -S \
  google-chrome pamixer pulseaudio-ctl volnoti qbittorrent \
  ttf-ms-fonts ttf-oxygen ttf-droid ttf-liberation ttf-ubuntu-font-family

# add user
useradd -m -g users -G wheesl,sys,lp,network,video,audio,storage,scannes,power -s /usr/bin/zsh perlinm

# set and synchronize system time
ln -sf /usr/share/zoneinfo/America/Los_Angeles /etc/localtime
timedatectl set-ntp true

# set keyboard layout
loadkeys /usr/share/kbd/keymaps/i386/colemak/colemak.map.gz
localectl set-keymap colemak
localectl set-x11-keymap us,us pc104 colemak, caps:backspace,shift:both_capslock
kbdrate -d 200 -r 60

# install packages for deft
pacman -S scons python2-markdown gnuplot haskell-hunit

# install windows partition utilities
pacman -S ntfs-3g
